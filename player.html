<!DOCTYPE html>
<html>
  <head>
    <style>
      .stuff {
        opacity: 0.5;
        position: absolute;
        z-index: 2147483647;
      }
    </style>
  </head>
  <body>
    <div style='width: 1800px; height: 1100px; position: relative; color: red;'>
      <img class="stuff" width="100" height="100" id='metadata_1'></img>

      <div class="stuff" id='info_1'></div>

      <div id='player0'></div>
      <div id='player1'></div>
      <div id='player2'></div>
      <div id='player3'></div>
    </div>

    <script type="text/javascript" src="demodulate.js"></script>

    <script>
      var content = new ArrayBuffer(0);

      function onReceiverCreateFail(reason) { }

      var videos_q = [];

      var buf = new ArrayBuffer(0);
      function onReceive(recvPayload) {
	try {
          v = JSON.parse(recvPayload);
	  if (videos_q.length <= 10) {
	    videos_q.push(v);
	  }
	} catch (e) {
	  console.log("failed to parse the message");
	}
      }
      function onDOMLoad() {
	messageReceivedCallback = onReceive;
	record();
      }

      document.addEventListener("DOMContentLoaded", onDOMLoad);

      // Player registry.
      var myPlayers = {};
      function getPlayerFromEvent(event) {
        return myPlayers[event.target.getIframe().id];
      }

      function onPlayerReady(event) {
        var that = getPlayerFromEvent(event);
        that.maybeNextVideo();
      }

      function onPlayerStateChange(event) {
        var that = getPlayerFromEvent(event);
        if (event.data == YT.PlayerState.ENDED && that.playing_) {
          // console.debug('onPlayerStateChange: ENDED');
          that.playing_ = false;
          that.maybeNextVideo()
        } else if (event.data == YT.PlayerState.PLAYING) {
          // console.debug('onPlayerStateChange: PLAYING');
          that.playing_ = true;
        }
      }

      function onPlayerError(event) {
        var that = getPlayerFromEvent(event);
        that.playing_ = false
        var error = parseInt(event.data)
        // Ignore not found and not allowed errors and load another video.
        if (error = 100 || error == 101 || error == 150) {
          setTimeout(function() { that.maybeNextVideo() }, 2100);
        }
      }

      class MyPlayer {
        constructor(id, x, y) {
          this.videoList_ = [];
          this.videoIndex_ = 0;
          this.loading_ = false;
          this.playing_ = false;

          this.player_ = new YT.Player(id, {
            width: '640',
            height: '480',
            playerVars: {
              'showinfo': '0',
              'modestbranding': '1',
              'controls': '0',
              'rel': '0',
            },
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange,
              'onError': onPlayerError
            }
          });
        }

        maybeNextVideo() {
          if (videos_q.length == 0) {
	    //console.log('queue empty, schdeluling a retry');
            var that = this;
            setTimeout(function() { that.maybeNextVideo() }, 1000);
            return;
          }
	  var v = videos_q.shift();

          this.player_.loadVideoById(
              {'videoId': v.v,
               'startSeconds': v.s,
               'endSeconds': v.s + 10});
          this.player_.mute();
        }
      }

      var tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      function onYouTubeIframeAPIReady() {
        // TODO: setup n players.
        for (var i = 0; i < 4; ++i) {
          var id = 'player' + i;
	  console.log('setting up player ', id);
          myPlayers[id] = new MyPlayer(id, parseInt(i % 2), parseInt(i / 2));
        }
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script type="text/javascript" src="demodulate.js"></script>

    sampling rate:<input type="text" id="fs" value="44100" disabled><br>
    noise threshold:<input type="text" id="noiseThreshold" value="" oninput="update()"><br>
    bit zero frequency:<input type="text" id="bitZeroFrequency" value="" oninput="update()"><br>
    bit one frequency:<input type="text" id="bitOneFrequency" value="" oninput="update()"><br>
    samples per bit:<input type="text" id="samplesPerBit" value="" oninput="update()"><br>
    <a href="player.html" id="playerLink">player</a>

    <canvas id="waveform0" width="1200" height="96"></canvas> <br>
    <canvas id="waveform1" width="1200" height="96"></canvas> <br>
    <canvas id="waveform2" width="1200" height="96"></canvas> <br>
    <canvas id="waveform3" width="1200" height="96"></canvas> <br>
    <canvas id="waveform4" width="1200" height="96"></canvas> <br>
    <canvas id="waveform5" width="1200" height="96"></canvas> <br>
    <canvas id="waveform6" width="1200" height="96"></canvas> <br>
    <canvas id="waveform7" width="1200" height="96"></canvas> <br>
    <canvas id="waveform8" width="1200" height="96"></canvas> <br>
    <canvas id="waveform9" width="1200" height="96"></canvas> <br>

    <script>
      var noiseThresholdBox = null;
      var bitZeroFrequencyBox = null;
      var bitOneFrequencyBox = null;
      var samplesPerBitBox = null;
      var fcBox = null;
      var numCanvasses = 10;
      var canvasses = [];
      var canvasIndex = numCanvasses;
      function getCanvas(index) { return canvasses[index % numCanvasses]; }

      function updatePlayerLink() {
        var ps = "";
        for (var param in demodulateParams) {
          if (demodulateParams.hasOwnProperty(param)) {
            if (ps.length > 0) {
              ps = ps + "&";
            }
            ps += param + "=" + demodulateParams[param];
          }
        }
        console.log(ps);
        if (ps.length > 0) {
          document.getElementById("playerLink").href = "player.html?" + ps;
        }
      }

      function update() {
	demodulateParams.noiseThreshold = parseFloat(noiseThresholdBox.value);
	demodulateParams.bitZeroFrequency = parseFloat(bitZeroFrequencyBox.value);
	demodulateParams.bitOneFrequency = parseFloat(bitOneFrequencyBox.value);
	demodulateParams.samplesPerBit = parseInt(samplesPerBitBox.value);
        updatePlayerLink();
      }

      function onDOMLoad() {
	fsBox = document.getElementById("fs");
	fsBox.value = audioContext.sampleRate;
        demodulateParams.samplingFrequency = audioContext.sampleRate;

	noiseThresholdBox = document.getElementById("noiseThreshold");
	bitZeroFrequencyBox = document.getElementById("bitZeroFrequency");
	bitOneFrequencyBox = document.getElementById("bitOneFrequency");
	samplesPerBitBox = document.getElementById("samplesPerBit");

	noiseThresholdBox.value = demodulateParams.noiseThreshold;
	bitZeroFrequencyBox.value = demodulateParams.bitZeroFrequency;
	bitOneFrequencyBox.value = demodulateParams.bitOneFrequency;
	samplesPerBitBox.value = demodulateParams.samplesPerBit;

        for (var i = 0; i < numCanvasses; i++) {
	  canvasses.push(document.getElementById("waveform" + i).getContext("2d"));
        }
	drawBufferCallback = function(buf, bufLength, highlights) {
	  updateWaveCanvas(getCanvas(canvasIndex), getCanvas(canvasIndex - 1),
                           buf, bufLength, highlights);
	  canvasIndex += 1;
	}
        updatePlayerLink();
	record();
      }
      document.addEventListener("DOMContentLoaded", onDOMLoad);

      function updateWaveCanvas(waveCanvas, oldCanvas, buf, bufLength, highlights) {
        var maxY = 0.01;
        for (var x = 0; x < bufLength; x++) {
          maxY = Math.max(maxY, Math.abs(buf[x]));
        }
	var canvasLength = 1024;
	var canvasHeight = 96;

        function timeToX(time) {
          return time / canvasLength;
        }
        function signalToY(signal) {
          return canvasHeight / 2 - (signal / (maxY * 1.05)) * (canvasHeight / 2);
        }
        function xToIndex(x) {
          return x * bufLength / canvasLength;
        }
        function indexToX(index) {
          return index * canvasLength / bufLength;
        }
	var stepSize = 128;
	waveCanvas.clearRect(0, 0, canvasLength + 100, canvasHeight);
	waveCanvas.strokeStyle = "red";
	waveCanvas.fillStyle = "red";
        waveCanvas.fillRect(canvasLength + 20, canvasHeight / 2, 10, 10);
        oldCanvas.clearRect(canvasLength + 20, canvasHeight / 2, 10, 10);
	waveCanvas.beginPath();
	for (var i = 0; i <= canvasLength / stepSize ; i += 1) {
	  waveCanvas.moveTo(i * stepSize, 0);
	  waveCanvas.lineTo(i * stepSize, canvasHeight);
	}
	waveCanvas.stroke();
	waveCanvas.strokeStyle = "black";
	waveCanvas.beginPath();
	waveCanvas.moveTo(0, signalToY(buf[0]));
	for (var x = 1; x < canvasLength; x++) {
	  waveCanvas.lineTo(x, signalToY(buf[xToIndex(x)]) );
	}

        var max = 0;
        var sum = 0;
        var count = 0;
        waveCanvas.globalAlpha = 0.2;
        waveCanvas.fillStyle = "lime";
        for (var i = 0; i < highlights.length; i++) {
          var indexStart = highlights[i][0];
          var indexEnd = indexStart + highlights[i][1];
          waveCanvas.fillRect(indexToX(indexStart), 0,
                              indexToX(indexEnd) - indexToX(indexStart), canvasHeight);
          for (var j = indexStart; j < indexEnd; j++) {
            max = Math.max(max, Math.abs(buf[j]));
            sum += Math.abs(buf[j]);
            count += 1;
          }
        }
        waveCanvas.globalAlpha = 1;
        var avg = sum / count;

	waveCanvas.stroke();
        waveCanvas.setLineDash([1, 3]);
        waveCanvas.beginPath();
        waveCanvas.moveTo(0, signalToY(max));
        waveCanvas.lineTo(canvasLength - 1, signalToY(max));
        waveCanvas.moveTo(0, signalToY(avg));
        waveCanvas.lineTo(canvasLength - 1, signalToY(avg));
	waveCanvas.stroke();
        waveCanvas.setLineDash([]);

        waveCanvas.font="10px Georgia";
	waveCanvas.fillStyle = "black";
        waveCanvas.fillText(max.toFixed(2), canvasLength, signalToY(max));
        waveCanvas.fillText(avg.toFixed(2), canvasLength, signalToY(avg));
        waveCanvas.fillText(maxY.toFixed(2), canvasLength, 7);
      }
    </script>
  </body>
</html>

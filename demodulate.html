<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script type="text/javascript" src="demodulate.js"></script>

    <canvas id="waveform0" width="1200" height="256"></canvas> <br>
    <canvas id="waveform1" width="1200" height="256"></canvas> <br>
    <canvas id="waveform2" width="1200" height="256"></canvas> <br>

    sampling rate:<input type="text" id="fs" value="44100" disabled><br>
    noise threshold:<input type="text" id="noiseThreshold" value="" oninput="update()"><br>
    bit threshold:<input type="text" id="zeroOneThreshold" value="" oninput="update()"><br>
    samples per bit:<input type="text" id="samplesPerBit" value="" oninput="update()"><br>
    <a href="player.html" id="playerLink">player</a>

    <script>
      var noiseThresholdBox = null;
      var zeroOneThresholdBox = null;
      var samplesPerBitBox = null;
      var fcBox = null;
      var canvasses = [];
      var canvasIndex = 3;
      function getCanvas(index) { return canvasses[index % 3]; }

      function updatePlayerLink() {
        var ps = "";
        for (var param in demodulateParams) {
          if (demodulateParams.hasOwnProperty(param)) {
            if (ps.length > 0) {
              ps = ps + "&";
            }
            ps += param + "=" + demodulateParams[param];
          }
        }
        console.log(ps);
        if (ps.length > 0) {
          document.getElementById("playerLink").href = "player.html?" + ps;
        }
      }

      function update() {
	demodulateParams.noiseThreshold = parseFloat(noiseThresholdBox.value);
	demodulateParams.zeroOneThreshold = parseFloat(zeroOneThresholdBox.value);
	demodulateParams.samplesPerBit = parseInt(samplesPerBitBox.value);
        //demodulateParams.carrierWaveFrequency = parseInt(fcBox.value);
        updatePlayerLink();
      }

      function onDOMLoad() {
	fcBox = document.getElementById("fc");
        //fcBox.value = demodulateParams.carrierWaveFrequency;

	fsBox = document.getElementById("fs");
	fsBox.value = audioContext.sampleRate;

	noiseThresholdBox = document.getElementById("noiseThreshold");
	zeroOneThresholdBox = document.getElementById("zeroOneThreshold");
	samplesPerBitBox = document.getElementById("samplesPerBit");
	noiseThresholdBox.value = demodulateParams.noiseThreshold;
	zeroOneThresholdBox.value = demodulateParams.zeroOneThreshold;
	samplesPerBitBox.value = demodulateParams.samplesPerBit;

	canvasses = [
	  document.getElementById("waveform0").getContext("2d"),
	  document.getElementById("waveform1").getContext("2d"),
	  document.getElementById("waveform2").getContext("2d"),
	];
	drawBufferCallback = function(buf, highlights) {
	  updateWaveCanvas(getCanvas(canvasIndex), getCanvas(canvasIndex - 1),
                           buf, highlights);
	  canvasIndex += 1;
	}
        updatePlayerLink();
	record();
      }
      document.addEventListener("DOMContentLoaded", onDOMLoad);

      function updateWaveCanvas(waveCanvas, oldCanvas, buf, highlights) {
	var canvasLength = 1024;
	var canvasHeight = 256;

        function timeToX(time) {
          return time / canvasLength;
        }
        function signalToY(signal) {
          return 128 - signal * 128;
        }
        function xToIndex(x) {
          return x * buf.length / canvasLength;
        }
        function indexToX(index) {
          return index * canvasLength / buf.length;
        }
        console.log(highlights);
	var stepSize = 128;
	waveCanvas.clearRect(0, 0, canvasLength + 100, canvasHeight);
	waveCanvas.strokeStyle = "red";
	waveCanvas.fillStyle = "red";
        waveCanvas.fillRect(canvasLength + 50, 128, 10, 10);
        oldCanvas.clearRect(canvasLength + 50, 128, 10, 10);
	waveCanvas.beginPath();
	for (var i = 0; i <= canvasLength / stepSize ; i += 1) {
	  waveCanvas.moveTo(i * stepSize, 0);
	  waveCanvas.lineTo(i * stepSize, canvasHeight);
	}
	waveCanvas.stroke();
	waveCanvas.strokeStyle = "black";
	waveCanvas.beginPath();
	waveCanvas.moveTo(0, 128 + buf[0] * 128);
	for (var x = 1; x < canvasLength; x++) {
	  waveCanvas.lineTo(x, signalToY(buf[xToIndex(x)]) );
	}

        var max = 0;
        var sum = 0;
        var count = 0;
        waveCanvas.globalAlpha = 0.2;
        waveCanvas.fillStyle = "lime";
        for (var i = 0; i < highlights.length; i++) {
          var indexStart = highlights[i][0];
          var indexEnd = indexStart + highlights[i][1];
          waveCanvas.fillRect(indexToX(indexStart), 0,
                              indexToX(indexEnd) - indexToX(indexStart), canvasHeight);
          for (var j = indexStart; j < indexEnd; j++) {
            max = Math.max(max, Math.abs(buf[j]));
            sum += Math.abs(buf[j]);
            count += 1;
          }
        }
        waveCanvas.globalAlpha = 1;
        var avg = sum / count;

	waveCanvas.stroke();
        waveCanvas.setLineDash([1, 3]);
        waveCanvas.beginPath();
        waveCanvas.moveTo(0, signalToY(max));
        waveCanvas.lineTo(canvasLength - 1, signalToY(max));
        waveCanvas.moveTo(0, signalToY(avg));
        waveCanvas.lineTo(canvasLength - 1, signalToY(avg));
	waveCanvas.stroke();
        waveCanvas.setLineDash([]);

        waveCanvas.font="10px Georgia";
	waveCanvas.fillStyle = "black";
        waveCanvas.fillText(max.toFixed(2), canvasLength, signalToY(max));
        waveCanvas.fillText(avg.toFixed(2), canvasLength, signalToY(avg));
      }
    </script>
  </body>
</html>
